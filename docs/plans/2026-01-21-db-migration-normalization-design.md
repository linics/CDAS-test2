# 数据库迁移规范化设计

## 背景与目标
当前数据库结构依赖运行时修补（动态补列/重建表），容易导致多次执行、数据覆盖、环境不一致等问题。目标是为核心表（assignments/submissions/evaluations）提供可追踪、可重放的迁移机制，替代运行时修补。

## 方案概述
- 引入轻量 SQL 迁移机制：在 `migrations/sql` 下按文件名排序执行。
- 使用 `schema_migrations` 表记录已执行版本。
- 启动时仅执行未应用迁移；执行前自动备份 `storage/cdas.db` 为 `.bak`。
- `app/db.py` 只负责调用迁移器，不再动态修补表结构。

## 迁移策略（核心表）
- 新增字段：`ALTER TABLE ADD COLUMN` + 默认值回填。
- 重命名/类型变更：使用 SQLite 标准“重建表 + 数据拷贝”模式。
- 历史数据补齐：在迁移脚本中一次性 `UPDATE`，不再重复覆盖。
- 追加必要索引（如 assignment_id、student_id、evaluation_type）。

## 错误处理
- 单迁移脚本在事务中执行，失败即回滚该脚本并停止后续执行。
- 错误信息包含脚本名和关键 SQL 片段，便于定位。

## 测试计划
- 新增集成测试：构造旧 schema，运行迁移器，断言核心表结构与关键字段存在。
- 断言 `schema_migrations` 记录正确，确保迁移可复现。

## 影响与风险
- 首次迁移会触发一次数据结构变更，建议备份后运行。
- 迁移脚本需严格评审，避免与现有数据不兼容。
